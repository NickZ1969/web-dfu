<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../sakura.css" />
    <title>WebUSB DFU</title>
    <script src="dfu.js"></script>
    <script src="dfuse.js"></script>
    <script src="FileSaver.js"></script>
    <script src="dfu-util.js"></script>
    <style>
      p.warning {
        color: red;
      }
      p.error {
        color: red;
        font-weight: bold;
      }
      label.radio {
        display: inline;
      }
      input:invalid {
        color:red;
      }
    </style>
  </head>
  <body>
    <a href="https://github.com/devanlai/webdfu"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
    <p>
      <button onclick="getGitHubFiles()">Refresh available firmware</button>
      <ul id="filelist"></ul>
      <span id="status"></span>
    </p>
   <p>
      <label for="vid">Vendor ID (hex): Do not use this box</label>
      <input list="vendor_ids" type="text" name="vid" id="vid" maxlength="6" size="8" pattern="0x[A-Fa-f0-9]{1,4}"/>
      <datalist id="vendor_ids">
        <option value="0x1209">dapboot DFU bootloader</option>
        <option value="0x0D28">mbed DAPLink</option>
        <option value="0x1EAF">LeafLabs Maple/stm32duino bootloader</option>
      </datalist>
    </p>
    <p>
      <button id="connect">Connect</button>
    </p>
    <dialog id="interfaceDialog">
      Your device has multiple DFU interfaces. Select one from the list below:
      <form id="interfaceForm" method="dialog">
        <button id="selectInterface" type="submit">Select interface</button>
      </form>
    </dialog>
    <p>
      <div id="usbInfo" style="white-space: pre"></div>
      <div id="dfuInfo" style="white-space: pre"></div>
    </p>
    <fieldset>
      <legend>Runtime mode</legend>
      <button id="detach" disabled="true">Detach DFU</button>
    </fieldset>
    <fieldset>
      <form id="configForm">
        <label for="transferSize">Transfer Size:</label>
        <input type="number" name="transferSize" id="transferSize" value="1024"/>
        <div id="dfuseFields" hidden="true">
          <label for="dfuseStartAddress">DfuSe Start Address:</label>
          <input type="text" name="dfuseStartAddress" id="dfuseStartAddress" title="Initial memory address to read/write from (hex)" size="10" pattern="0x[A-Fa-f0-9]+"/>
          <label for="dfuseUploadSize">DfuSe Upload Size:</label>
          <input type="number" name="dfuseUploadSize" id="dfuseUploadSize" min="1"/>
        </div>
      
        <legend>DFU mode</legend>
        <fieldset>
          <legend>Upload Firmware to ECU</legend>
          <p>
            <input type="file" id="firmwareFile" name="file" disabled="true"/>
          </p>
          <p>
            <button id="download" disabled="true">Download</button>
          </p>
          <div class="log" id="downloadLog"></div>
        </fieldset>
        <fieldset>
          <p>
            <button id="upload" disabled="true" hidden>Upload</button>
          </p>          <div class="log" id="uploadLog"></div>
        </fieldset>
      </form>
    </fieldset>
    <h1>About</h1>
    <p>
      This is a proof-of-concept demo of host <a href="http://wiki.openmoko.org/wiki/USB_DFU">USB DFU</a> drivers in Javascript utilizing the <a href="https://wicg.github.io/webusb/">WebUSB</a> draft standard to implement USB firmware updates from the browser.
    </p>
<script>
    async function getGitHubFiles() {
            // <input type="text" id="owner" placeholder="Nickz1969">
    // <input type="text" id="repo" placeholder="firmware">
       // const owner = document.getElementById('owner').value;
      //  const repo = document.getElementById('repo').value;
        const owner = document.getElementById('Nickz1969');
        const repo = document.getElementById('firmware');
          const fileList = document.getElementById('fileList');

        // Use the GitHub API to fetch the repository contents
        const apiUrl = `https://api.github.com/repos/Nickz1969/firmware/contents`;
        try {
          const response = await fetch(apiUrl);
          const data = await response.json();

          if (response.status === 200) {
            fileList.innerHTML = ''; // Clear previous results

            data.forEach(item => {
              if (item.type === 'file') {
                const listItem = document.createElement('li');
                const downloadButton = document.createElement('button');
                downloadButton.textContent = 'Download';
                downloadButton.onclick = () => downloadFile(item.download_url, item.name);

                listItem.innerHTML = `<a href="${item.html_url}" target="_blank">${item.name}</a>`;
                listItem.appendChild(downloadButton);
                fileList.appendChild(listItem);
              }
            });
          } else {
            fileList.innerHTML = 'Repository not found or inaccessible.';
          }
        } catch (error) {
          console.error('Error fetching GitHub files:', error);
          fileList.innerHTML = 'An error occurred while fetching files.';
        }
      }
      async function downloadFile(url, fileName) {
        downloadedFileName = null;
        try {
          const response = await fetch(url);
          const blob = await response.blob();

          // Create a temporary link to trigger the download
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          downloadedFileName = fileName;
          downloadiniFile();
           } catch (error) {
          console.error('Error downloading file:', error);
        }
      }
      async function downloadiniFile() {
        const iniUrl = `https://raw.githubusercontent.com/NickZ1969/speeduino_ini_files/main/${downloadedFileName.replace(/\.[^/.]+$/, '.ini')}`;
        try {
          const response = await fetch(iniUrl);
          const blob = await response.blob();
          // Create a temporary link to trigger the download
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = downloadedFileName.replace(/\.[^/.]+$/, '.ini');
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
           } catch (error) {
          console.error('Error downloading file:', error);
        }
      }
</script>
  </body>
</html>
